# Chrome拡張機能「ブログ投稿アシスタント」要件定義・設計書

## 概要

ChatGPT/Claudeで作成したブログ記事をワンクリックでWordPressに投稿できるChrome拡張機能。

**ターゲットユーザー:** 非エンジニア、WordPress初心者

**対応AIサービス:**
- ChatGPT (chat.openai.com, chatgpt.com)
- Claude (claude.ai)
- Gemini (gemini.google.com)

---

## コア機能

```
┌─ ChatGPT/Claude ─────────────────────────────┐
│                                              │
│  ```markdown                                 │
│  ---                                         │
│  title: SEO対策の基本                        │
│  categories:                                 │
│    - マーケティング                          │
│  tags:                                       │
│    - SEO                                     │
│  date: 2026-01-14T10:00                      │
│  ---                                         │
│                                              │
│  ## はじめに                                 │
│  検索エンジン最適化とは...                   │
│  ```                                         │
│                           ┌────────────┐     │
│                           │ 📤 投稿   │     │
│                           └────────────┘     │
└──────────────────────────────────────────────┘
```

**動作フロー:**
1. ユーザーがAIに「コードブロックでMarkdown形式で出力して」と指示
2. 拡張機能が ` ```markdown ` ブロックを自動検出
3. 「投稿」ボタンが表示される
4. クリックで確認ダイアログ → WordPress投稿
5. タグは前回入力値を自動で初期表示（Front Matterのtagsがある場合はそちらを優先）

---

## ファイル構成

```
~/Desktop/wp-blog-poster-extension/   # ← 新規ディレクトリに作成
├── manifest.json                     # Manifest V3
├── popup/
│   ├── popup.html                   # 設定画面
│   ├── popup.css
│   └── popup.js
├── content/
│   ├── content.js                   # コードブロック検出
│   └── content.css                  # 投稿ボタン・ダイアログ
├── background/
│   └── background.js                # WordPress API通信 + 画像アップロード
├── libs/
│   ├── marked.min.js                # Markdown→HTML
│   └── js-yaml.min.js               # Front Matter解析
├── assets/icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── setup-guide/
│   └── setup-guide.html             # 初心者向けセットアップガイド
└── docs/
    └── 要件定義・設計書.md           # この設計書
```

**成果物:** `wp-blog-poster-extension.zip` としてZIPファイルを作成

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| マニフェスト | Manifest V3 |
| Markdown変換 | marked.js |
| YAML解析 | js-yaml |
| 認証情報保存 | chrome.storage.local |
| API通信 | fetch API (Service Worker) |
| 認証方式 | HTTP Basic Auth + Application Password |

---

## UI設計（非エンジニア向け）

### 1. 初期設定ウィザード（3ステップ）

```
┌─────────────────────────────────────────┐
│  ブログ投稿アシスタント                  │
├─────────────────────────────────────────┤
│                                         │
│  🎉 ようこそ！                          │
│  WordPressと接続しましょう              │
│                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  ステップ 1/3: サイトURL                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                         │
│  サイトのURL                            │
│  ┌─────────────────────────────────┐   │
│  │ https://your-site.com           │   │
│  └─────────────────────────────────┘   │
│  💡 トップページのURLを入力            │
│                                         │
│       [  次へ進む →  ]                  │
│                                         │
│  [📖 設定方法がわからない方はこちら]    │
└─────────────────────────────────────────┘
```

### 2. 投稿設定（デフォルト設定）

```
┌─────────────────────────────────────────┐
│ 投稿設定                                 │
│ デフォルトの投稿状態                     │
│  ● 下書き                               │
│  ○ 公開                                 │
│  ○ 予約投稿                             │
│     公開日時: [2026-01-14] [10:00]       │
│                                         │
│ [ ] 存在しないカテゴリ/タグを自動作成   │
│                                         │
│ [ 設定を保存 ]   [ 接続テスト ]          │
└─────────────────────────────────────────┘
```

- 予約投稿が選択された場合は「公開日時」を必須入力にする
- Front Matterのdateがあれば初期値に反映し、なければ次の正時を初期値にする
- 投稿確認ダイアログは、ここで選んだデフォルト状態を初期選択にする
- サイトのタイムゾーンを明示し、日時のズレを防ぐ

### 3. 投稿確認ダイアログ

```
┌───────────────────────────────────────────┐
│  📝 投稿内容の確認                   [×] │
├───────────────────────────────────────────┤
│                                           │
│  タイトル                                 │
│  ┌─────────────────────────────────────┐ │
│  │ SEO対策の基本                       │ │
│  └─────────────────────────────────────┘ │
│                                           │
│  カテゴリ: マーケティング                │
│  タグ: SEO                               │
│                                           │
│  投稿状態                                 │
│  ● 下書きとして保存                      │
│  ○ 公開する                              │
│  ○ 予約投稿する                          │
│    公開日時: 2026-01-14 10:00             │
│                                           │
│  ▼ 本文プレビュー (1,234文字)            │
│  ┌─────────────────────────────────────┐ │
│  │ はじめに...                         │ │
│  └─────────────────────────────────────┘ │
│                                           │
│  [キャンセル]        [📤 投稿する]       │
└───────────────────────────────────────────┘
```

### 4. ボタンデザイン指針

**WordPressに投稿するボタン（確認ダイアログの主CTA）**
- 形状: 高さ44px前後のピル型、角丸12px
- 色: クールな青〜シアンのグラデーション（例: #1F7AE0 → #35D2E8）
- 影: 低めのソフトシャドウ + ホバー時に浅い発光
- 状態: hoverで1-2px浮き上がり、activeで軽く沈む
- 無効: 不透明度40% + 影なし

**コードブロック内の投稿ボタン（軽量CTA）**
- 位置: コードブロック右上に固定、邪魔にならないサイズ
- 背景: 半透明のダークグラス（例: rgba(11,18,32,0.55) + 1pxボーダー）
- 表示: 通常はアイコンのみ、hoverで「投稿」ラベルが展開
- 文字: 細めのサンセリフ、トラッキングをわずかに広げる
- 動き: 120ms程度のスライド + フェードで出現

### 5. UI/UXブラッシュアップ提案

- 投稿プレビューに「推定タイトル/カテゴリ/タグ」をチップ表示し、ワンクリック編集
- 予約投稿のタイムゾーン表記を固定表示（例: JST / UTC+9）
- 投稿成功時に「WordPressで開く」「URLコピー」の2アクションを提示
- 画像アップロード進捗（枚数/残り）を表示し、待機ストレスを軽減
- エラー詳細をコピーできる「診断ログ」ボタンを追加

---

## WordPress REST API エンドポイント

| エンドポイント | メソッド | 用途 |
|---------------|---------|------|
| `/wp-json/wp/v2/users/me` | GET | 接続テスト |
| `/wp-json/wp/v2/categories?search=` | GET | カテゴリ検索 |
| `/wp-json/wp/v2/tags?search=` | GET | タグ検索 |
| `/wp-json/wp/v2/categories` | POST | カテゴリ作成 |
| `/wp-json/wp/v2/tags` | POST | タグ作成 |
| `/wp-json/wp/v2/media` | GET | 画像重複チェック |
| `/wp-json/wp/v2/media` | POST | 画像アップロード |
| `/wp-json/wp/v2/posts` | POST | 記事投稿 |

---

## 画像アップロード機能

### 対応する画像パターン

```
1. 外部URL画像（https://example.com/image.png）
   → fetchで取得 → WordPressにアップロード → URL置換

2. Markdownの画像記法
   ![alt text](https://example.com/image.png)
   → 検出 → アップロード → URLをWordPress URLに置換

3. 最初の画像をアイキャッチに設定（オプション）
```

### 処理フロー

```
記事内の画像検出
       ↓
┌──────────────────────┐
│ 画像URLを抽出        │
│ - Markdown: ![](url) │
│ - HTML: <img src="">  │
└──────────────────────┘
       ↓
┌──────────────────────┐
│ 各画像をfetchで取得  │
│ (外部URL → Blob)     │
└──────────────────────┘
       ↓
┌──────────────────────┐
│ WordPress Media API  │
│ にアップロード       │
└──────────────────────┘
       ↓
┌──────────────────────┐
│ 記事内のURLを        │
│ WordPress URLに置換  │
└──────────────────────┘
```

### 制限事項

- ローカルファイルパス（file://）は非対応（Chrome拡張の制限）
- CORS制限のある画像は取得できない場合あり
- 対応形式: JPEG, PNG, GIF, WebP

---

## 移植するPythonロジック（post_to_wp.pyから）

1. **Front Matter解析** - `parse_front_matter()`
2. **タイトル抽出** - `extract_title()` (Front Matter > H1 > H2 > ファイル名)
3. **タイトル見出し除去** - `remove_heading_matching_title()`
4. **カテゴリ/タグ解決** - `resolve_category_ids()`, `resolve_tag_ids()`
5. **日付正規化** - `normalize_date_for_wp()`

---

## エラーハンドリング（日本語メッセージ）

| エラー | メッセージ |
|--------|-----------|
| 401 | ユーザー名またはパスワードが間違っています |
| 403 | このユーザーには投稿権限がありません |
| 404 | WordPressが見つかりません。URLを確認してください |
| 500 | サーバーエラーが発生しました |
| ネットワーク | インターネット接続を確認してください |

---

## WordPress設定手順（初心者向けガイド）

### アプリケーションパスワードの発行方法

```
Step 1: WordPress管理画面にログイン
        https://あなたのサイト.com/wp-admin/

Step 2: 左メニュー「ユーザー」→「プロフィール」

Step 3: 下にスクロール →「アプリケーションパスワード」

Step 4: 名前に「ブログ投稿アシスタント」と入力

Step 5: 「新しいアプリケーションパスワードを追加」をクリック

Step 6: 表示されたパスワードをコピー
        ⚠️ 一度しか表示されません！

        形式: xxxx xxxx xxxx xxxx xxxx xxxx
        （スペースを含めてそのままコピーOK）
```

### トークンプラグイン方式（サーバ設定不要・推奨）

```
Step 1: wp-plugin/wp-blog-poster-token-auth をZIP化
Step 2: WordPress管理画面 → プラグイン → 新規追加 → プラグインのアップロード
Step 3: 有効化後、ツール → Blog Poster Token を開く
Step 4: Generate Token を押してトークンをコピー
Step 5: 拡張機能の「アクセストークン」に貼り付け
```

※ 一部のホスティングではカスタムヘッダーが落ちるため、
   トークンはクエリパラメータ `wpbp_token` でも送信できるようにする。

---

## セキュリティ対策

- HTTPS必須（HTTPは拒否）
- 認証情報はchrome.storage.localに保存（Chrome暗号化）
- 外部サーバー経由なし（直接WordPress APIに通信）
- アプリケーションパスワード使用（メインパスワード非使用）
- トークンプラグイン方式も選択可能（サーバ設定不要）
- 最小権限の原則（必要なpermissionsのみ）

---

## 実装ステップ

### Phase 1: 基本構造
- [ ] manifest.json作成
- [ ] popup UI（設定ウィザード）
- [ ] chrome.storage設定保存

### Phase 2: WordPress API連携
- [ ] 接続テスト機能
- [ ] カテゴリ/タグ解決
- [ ] 投稿作成API

### Phase 3: コンテンツスクリプト
- [ ] MutationObserverでコードブロック検出
- [ ] Front Matter解析（js-yaml）
- [ ] Markdown→HTML変換（marked.js）

### Phase 4: UI/UX
- [ ] 投稿ボタンUI
- [ ] 確認ダイアログ
- [ ] 成功/エラー通知
- [ ] 投稿設定に予約投稿（日時入力）を追加
- [ ] 投稿ボタンのデザイン洗練（主CTA/コードブロック内）

### Phase 5: ドキュメント
- [ ] 初心者向けセットアップガイド
- [ ] 使い方説明

---

## 対象ファイル（移植元）

- [post_to_wp.py](post_to_wp.py) - メインロジック
- [articles/sample_with_frontmatter.md](articles/sample_with_frontmatter.md) - Front Matterサンプル
- [tests/test_post_to_wp.py](tests/test_post_to_wp.py) - 動作仕様の参照

---

## 検証方法

1. **設定テスト**: 拡張機能popupで「接続テスト」→ 成功メッセージ
2. **検出テスト**: ChatGPT/Claudeで ` ```markdown ` ブロック出力 → 投稿ボタン表示
3. **投稿テスト**: 投稿ボタン → 確認ダイアログ → 下書き投稿 → WordPress管理画面で確認
4. **エラーテスト**: 誤った認証情報で接続 → エラーメッセージ表示
