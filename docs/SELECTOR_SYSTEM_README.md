# セレクタ動的設定システム - ドキュメント一覧

このディレクトリには、Chrome 拡張機能でマークダウンコンテンツのセレクタを動的に設定・更新できるシステムの全仕様が記載されています。

## 📋 ドキュメント構成

### 1. **SELECTOR_CONFIGURATION_SPEC.md** ⭐ 必読
   - **対象:** システムの全体設計を理解したい方
   - **内容:**
     - システムの概要と目的
     - ポップアップUI仕様（レイアウト、入力項目）
     - データ構造定義（JSON スキーマ）
     - 実行フロー図
     - エラーハンドリング
     - セキュリティ考慮事項
     - テスト仕様
   - **ボリューム:** 詳細（約 500 行）
   - **読む時間:** 30-40 分

### 2. **SELECTOR_IMPLEMENTATION_CHECKLIST.md** ⭐ 実装時に参照
   - **対象:** システムを実装・開発する方
   - **内容:**
     - 9 フェーズに分かれた実装タスク
     - 各フェーズの詳細チェックリスト
     - コード実装例
     - テスト項目
     - デプロイ手順
     - 進捗追跡テンプレート
   - **ボリューム:** 実装ガイド（約 400 行）
   - **用途:** 実装中の確認、進捗管理

### 3. **SELECTOR_GUIDE.md** ⭐ セレクタ作成時に参照
   - **対象:** セレクタルールを作成・編集する方
   - **内容:**
     - CSS セレクタの基本文法
     - サービス別セレクタ例（ChatGPT, Claude, Gemini）
     - よくあるパターン 6 種類
     - トラブルシューティング
     - 実践例 3 つ
     - ベストプラクティス
     - デバッグコマンド集
   - **ボリューム:** 実践ガイド（約 450 行）
   - **用途:** セレクタ作成時、トラブル解決時

---

## 🎯 用途別 読み方ガイド

### 📌 「まずシステム全体を理解したい」

1. このファイルを読む（5 分）
2. **SELECTOR_CONFIGURATION_SPEC.md** の以下セクション:
   - 1. 概要
   - 2. 目的
   - 5. 全体アーキテクチャ
   - 6. ポップアップ UI 仕様（6.1 レイアウト）

### 📌 「すぐに実装を始めたい」

1. **SELECTOR_IMPLEMENTATION_CHECKLIST.md** を全て読む（20 分）
2. フェーズ 1 から順番にチェックボックスを埋める
3. 必要に応じて **SELECTOR_CONFIGURATION_SPEC.md** の詳細を参照

### 📌 「セレクタが反応しない」（トラブル対応）

1. **SELECTOR_GUIDE.md** の以下セクション:
   - トラブルシューティング
   - デバッグコマンド集
2. **SELECTOR_CONFIGURATION_SPEC.md** → エラーハンドリング

### 📌 「新しいセレクタを追加したい」

1. **SELECTOR_GUIDE.md** の以下セクション:
   - CSS セレクタの基本
   - よくあるパターン
   - 実践例
2. ポップアップから以下を入力:
   - ルール名、セレクタ、タイプ、説明、フォールバック
3. [テスト実行] で検証

---

## 🏗️ システムの全体像（3 分で理解）

```
【ユーザー（非開発者）】
          │
          │ ポップアップUIで設定
          ▼
┌─────────────────────────────────┐
│  Chrome 拡張機能 - ポップアップ  │
│  ┌─────────────────────────────┐ │
│  │ セレクタ設定タブ             │ │
│  │ - サービス選択              │ │
│  │ - セレクタ入力フォーム      │ │
│  │ - テスト & プレビュー       │ │
│  │ - 保存ボタン                │ │
│  └─────────────────────────────┘ │
└────────────┬────────────────────┘
             │
   (Storage API で保存)
             │
             ▼
┌─────────────────────────────────┐
│  Chrome Storage                  │
│  {                               │
│    selectorSchemas: {            │
│      "chatgpt": {...},          │
│      "claude": {...},           │
│      "gemini": {...}            │
│    }                             │
│  }                               │
└────────────┬────────────────────┘
             │
  (Content Script が読み込み)
             │
             ▼
┌─────────────────────────────────┐
│  content.js                      │
│  - サービス判定                 │
│  - スキーマ読み込み             │
│  - セレクタ実行                 │
│  - マークダウン抽出             │
└─────────────────────────────────┘
             │
             ▼
【AI サービスの画面から
 マークダウンを抽出】
```

**重要ポイント:**
- ユーザーは **コード一行も書かない** → ポップアップで設定するだけ
- UI 変更時は **セレクタのみ更新** → 仕様変更に即座に対応
- 複数ルール対応 → 一つのセレクタが失敗しても別のルールで フォールバック

---

## 💾 ストレージデータ構造（必須理解）

```javascript
chrome.storage.local に保存されるデータ形式:

{
  "selectorSchemas": {
    "chatgpt": {
      "version": "2.1.0",
      "lastUpdated": "2026-01-16T15:30:00Z",
      "service": "chatgpt",
      "rules": [
        {
          "ruleName": "markdownHeadings",
          "selector": "span",
          "type": "text",
          "description": "マークダウン見出し",
          "fallback": "span[role='none']",
          "enabled": true,
          "priority": 100
        },
        // ... その他のルール
      ]
    },
    "claude": { ... },
    "gemini": { ... }
  }
}
```

**ruleName (ルール識別子)**
- ユニークである必要がある
- アプリケーション側で `responseText`, `codeBlock` など定義して使用

**priority（優先度）**
- 0-100 の値
- 高いほど優先的に実行
- マッチしたら次のルールはスキップ

---

## 🔧 実装の 3 大ステップ

### ステップ 1: ポップアップUIを作成
- **ファイル:** `popup/popup.html`, `popup.css`
- **参考:** SELECTOR_CONFIGURATION_SPEC.md の「6. ポップアップ UI 仕様」
- **チェックリスト:** SELECTOR_IMPLEMENTATION_CHECKLIST.md「フェーズ 1」

### ステップ 2: ストレージ管理とバリデーション
- **ファイル:** `popup/popup.js` の UI ロジック + 検証関数
- **参考:** SELECTOR_CONFIGURATION_SPEC.md の「7. データ構造仕様」
- **チェックリスト:** SELECTOR_IMPLEMENTATION_CHECKLIST.md「フェーズ 3-6」

### ステップ 3: Content Script でセレクタを実行
- **ファイル:** `content/content.js` にセレクタ実行エンジンを追加
- **参考:** SELECTOR_CONFIGURATION_SPEC.md の「8. 実行フロー」
- **チェックリスト:** SELECTOR_IMPLEMENTATION_CHECKLIST.md「フェーズ 4」

---

## 📝 実装開始前のチェックリスト

```
[ ] 3 つのドキュメントを一度は流し読みした
[ ] システム全体の流れを図で理解した
[ ] SELECTOR_IMPLEMENTATION_CHECKLIST.md を開きながら進める
[ ] Chrome DevTools で現在のセレクタを確認した
[ ] デフォルトセレクタを 決定した（ChatGPT, Claude, Gemini）
[ ] Storage API の使用方法を確認した
[ ] メッセージパッシングの流れを理解した
```

---

## 🐛 よくあるエラーと対策

| エラー | 原因 | 解決方法 |
|--------|------|--------|
| "マッチする要素がありません" | セレクタが無効または要素が変わった | SELECTOR_GUIDE.md トラブルシューティング |
| Storage が空 | 初期スキーマが作成されていない | SELECTOR_IMPLEMENTATION_CHECKLIST.md フェーズ 3.1 |
| ポップアップに反映されない | メッセージパッシング未実装 | SELECTOR_CONFIGURATION_SPEC.md 8. 実行フロー |
| セレクタが複数マッチしすぎ | セレクタが広すぎる | SELECTOR_GUIDE.md ベストプラクティス |

---

## 📚 関連ファイル

```
wp-blog-poster-extension/
├── docs/
│   ├── SELECTOR_CONFIGURATION_SPEC.md       ← システム仕様書
│   ├── SELECTOR_IMPLEMENTATION_CHECKLIST.md  ← 実装チェックリスト
│   ├── SELECTOR_GUIDE.md                     ← セレクタ書き方ガイド
│   └── SELECTOR_SYSTEM_README.md             ← このファイル
│
├── popup/
│   ├── popup.html  ← UI 作成ここ
│   ├── popup.js    ← ロジック実装ここ
│   └── popup.css
│
├── content/
│   ├── content.js  ← セレクタ実行エンジン実装ここ
│   └── content.css
│
├── background/
│   └── background.js  ← メッセージハンドリング実装ここ
│
└── manifest.json
```

---

## 🚀 推奨実装順序

```
Week 1:
  ├─ ドキュメント読破（2 時間）
  ├─ デフォルトスキーマ定義（2 時間）
  └─ popup.html 基本骨組み作成（3 時間）

Week 2:
  ├─ popup.js - UI ロジック実装（6 時間）
  ├─ Storage 管理実装（4 時間）
  └─ バリデーション関数実装（4 時間）

Week 3:
  ├─ content.js - セレクタエンジン実装（6 時間）
  ├─ メッセージパッシング実装（4 時間）
  └─ テスト & デバッグ（4 時間）

Week 4:
  ├─ 全サービス対応テスト（4 時間）
  ├─ エラーハンドリング強化（4 時間）
  └─ ドキュメント最終確認（2 時間）
```

---

## 🎓 学習ポイント

このシステムを実装することで学べること:

- ✅ Chrome Storage API の実装
- ✅ Content Script とポップアップ間のメッセージングパッシング
- ✅ 動的な CSS セレクタの構築と実行
- ✅ バリデーション と エラーハンドリング
- ✅ UI/UX の設計（非技術者向け）
- ✅ バージョン管理戦略

---

## ❓ よくある質問

### Q1: セレクタが複数マッチする場合はどうする？

**A:** `priority` フィールドで優先度を指定。複数ルールで対応可能。

```javascript
ルール 1: priority 100 → span.response (高優先度)
ルール 2: priority 90 → div > span (中優先度)
ルール 3: priority 50 → span (低優先度)
```

最初にマッチしたルールが採用される。

### Q2: セレクタが無効になったかどうかはどう判定？

**A:** ポップアップの [テスト実行] ボタンで自動検証。

```
マッチ数: 0 件 → ❌ エラー表示
マッチ数: 1-100 件 → ✓ 正常（想定範囲による）
マッチ数: 1000+ 件 → ⚠️ 警告
```

### Q3: 複数サービスで同じルール名を使っても大丈夫？

**A:** 大丈夫。各サービスのスキーマが独立しているため。

```javascript
chatgpt スキーマの responseText: "span"
claude スキーマの responseText: "div[role='article'] span"
gemini スキーマの responseText: "div.response"

// アプリが自動的に正しい serviceSchema を選択
```

### Q4: セレクタのバージョン管理は必須？

**A:** 推奨ですが、初期段階では省略可能。

```javascript
簡易版: "version": "1.0"
詳細版: "version": "2.1.3" (Minor が追加数, Patch が修正数)
```

### Q5: JSON をテキストで編集できる？

**A:** 可能ですが非推奨。セキュリティリスク。

推奨: ポップアップ UI 経由で管理

代替案: エクスポート JSON 機能で バックアップ・比較

---

## 📞 サポート & フィードバック

- バグ報告: `./issues/`
- 仕様に関する質問: このドキュメントのセクション番号を記載
- セレクタの書き方相談: `SELECTOR_GUIDE.md` のセクション参照

---

## 📌 重要な注意事項

⚠️ **セキュリティ上の注意**
- セレクタに `javascript:` や `onerror` など危険なパターンを含めない
- API キー、個人情報などをセレクタに含めない
- ユーザーが入力したセレクタを必ず検証する

✅ **パフォーマンス上の注意**
- セレクタは仕様変更時のみ更新（毎回実行ではない）
- 複雑すぎるセレクタは避ける
- DOM クエリ結果はメモ化を検討

---

**最終更新日**: 2026-01-16
**ドキュメントバージョン**: 1.0
**対応拡張機能バージョン**: 1.0+

---

> 💡 **Tips:** このドキュメント 4 つを印刷またはブックマークしておくと、実装中の参照が快適です。
